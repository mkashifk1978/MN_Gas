fetch(url)
  .then(response => response.text())
  .then(data => {
    const rows = data.trim().split("\n").map(r => r.split(","));
    const headers = rows[0];
    const lastRow = rows[rows.length - 1];

    console.log("Headers:", headers);
    console.log("Last Row Data:", lastRow);

    const getValue = key => {
      const idx = headers.indexOf(key);
      console.log(`Key: ${key}, Index: ${idx}`); // Log the key and its index
      return idx !== -1 ? lastRow[idx] : "";
    };

    // --- Machines Table ---
    const machineTable = document.getElementById("machineTable").querySelector("tbody");
    machineMap.forEach(([name, todayKey, prevKey]) => {
      const row = machineTable.insertRow();
      row.insertCell().textContent = name;
      row.insertCell().textContent = getValue(todayKey);
      row.insertCell().textContent = getValue(prevKey);
    });

    // --- Main Line Table ---
    const mainLineTable = document.getElementById("mainLineTable").querySelector("tbody");
    const prevTotal =
      parseFloat(getValue("PREV_MAIN_GAS_LINE_1_TOTAL") || 0) +
      parseFloat(getValue("PREV_MAIN_GAS_LINE_2_TOTAL") || 0);

    mainLineMap.forEach(([name, todayKey, prevKey]) => {
      const row = mainLineTable.insertRow();
      row.insertCell().textContent = name;
      row.insertCell().textContent = getValue(todayKey);
      if (name === "TOTAL") {
        row.insertCell().textContent = prevTotal;
      } else {
        row.insertCell().textContent = prevKey ? getValue(prevKey) : "-";
      }
    });
  })
  .catch(error => console.error("Error fetching data:", error));
